name: Check MDN translation sync and send LINE notify

on:
  schedule:
    - cron: '0 4 * * *'  # æ¯å¤© 12:00 å°ç£æ™‚é–“ï¼ˆUTC+8ï¼‰
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  check-and-notify:
    runs-on: ubuntu-latest # åœ¨ Ubuntu ç’°å¢ƒåŸ·è¡Œ

    steps:
      - name: Checkout mdn/content # ä¸‹è¼‰ mdn/content å„²å­˜åº«
        uses: actions/checkout@v4
        with:
          repository: mdn/content
          path: content
          fetch-depth: 0  # éœ€è¦å®Œæ•´ git log ä¾†æ¯”è¼ƒæäº¤æ­·å²

      - name: Checkout mdn/translated-content # ä¸‹è¼‰ mdn/translated-content å„²å­˜åº«
        uses: actions/checkout@v4
        with:
          repository: mdn/translated-content
          path: translated-content

      - name: Set up Node.js + js-yaml # è¨­å®š Node.js ç’°å¢ƒä¸¦å®‰è£ js-yaml
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install js-yaml # å®‰è£ js-yaml npm å¥—ä»¶
        run: npm install js-yaml

      - name: Compare sourceCommit and generate log # æ¯”è¼ƒåŸæ–‡èˆ‡ç¿»è­¯çš„ sourceCommit ä¸¦ç”¢ç”Ÿæ—¥èªŒ
        run: |
          LOG_FILE="log.txt"
          > "$LOG_FILE" # æ¸…ç©ºæˆ–å»ºç«‹æ—¥èªŒæª”

          # å°‹æ‰¾æ‰€æœ‰ç¹é«”ä¸­æ–‡çš„ Markdown æª”æ¡ˆ
          find translated-content/files/zh-tw -name '*.md' | while read -r file; do
            # æå– YAML Front Matter
            yaml_metadata=$(awk '/^---$/{y++} y==1' "$file")
            # ä½¿ç”¨ Node.js å’Œ js-yaml è§£æ sourceCommit
            source_commit=$(node -e "
              const yaml = require('js-yaml');
              const meta = yaml.load(\`${yaml_metadata}\`);
              console.log(meta?.l10n?.sourceCommit || '');
            ")

            [ -z "$source_commit" ] && continue # å¦‚æœæ²’æœ‰ sourceCommit å‰‡è·³é

            # æ§‹å»ºå°æ‡‰çš„è‹±æ–‡åŸæ–‡è·¯å¾‘
            relative_path=${file#translated-content/files/zh-tw}
            en_path="files/en-us$relative_path"
            en_file="content/$en_path"

            [ ! -f "$en_file" ] && continue # å¦‚æœè‹±æ–‡åŸæ–‡æª”æ¡ˆä¸å­˜åœ¨å‰‡è·³é

            # å–å¾—è‹±æ–‡åŸæ–‡æª”æ¡ˆçš„æœ€æ–°æäº¤ ID
            latest_commit=$(git -C content log -n 1 --format=%H -- "$en_path")

            [ "$source_commit" = "$latest_commit" ] && continue # å¦‚æœæäº¤ ID ç›¸åŒå‰‡è¡¨ç¤ºå·²åŒæ­¥ï¼Œè·³é

            # è¨ˆç®—ç¿»è­¯è½å¾ŒåŸæ–‡çš„æäº¤æ•¸é‡
            distance=$(git -C content rev-list --count "$source_commit..$latest_commit" -- "$en_path")

            # å°‡çµæœå¯«å…¥æ—¥èªŒæª”
            echo "$relative_path, $distance" >> "$LOG_FILE"
          done

      - name: Upload log file # ä¸Šå‚³æ—¥èªŒæª”ä½œç‚º Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mdn-l10n-outdated-log
          path: log.txt

      - name: Format message and send LINE notification # æ ¼å¼åŒ–è¨Šæ¯ä¸¦ç™¼é€ LINE é€šçŸ¥
        if: success() # åƒ…åœ¨å‰é¢çš„æ­¥é©ŸæˆåŠŸæ™‚åŸ·è¡Œ
        run: |
          if [ ! -s log.txt ]; then # å¦‚æœæ—¥èªŒæª”ç‚ºç©ºï¼Œè¡¨ç¤ºæ²’æœ‰éæ™‚æª”æ¡ˆ
            echo "No outdated files found."
            exit 0
          fi

          declare -A groups # å®£å‘Šä¸€å€‹é—œè¯é™£åˆ—ä¾†å„²å­˜åˆ†é¡å¾Œçš„æª”æ¡ˆ

          NEWLINE=$'\n' # å®šç¾©ä¸€å€‹åŒ…å«å¯¦éš›æ›è¡Œç¬¦è™Ÿçš„è®Šæ•¸

          while IFS= read -r line; do
            path=$(echo "$line" | cut -d',' -f1 | xargs) # æå–æª”æ¡ˆè·¯å¾‘ä¸¦å»é™¤ç©ºç™½
            distance=$(echo "$line" | cut -d',' -f2 | xargs) # æå–è½å¾Œæ•¸é‡ä¸¦å»é™¤ç©ºç™½

            # å¾è·¯å¾‘ä¸­æå–å‰å…©å±¤è³‡æ–™å¤¾ä½œç‚ºåˆ†é¡æ¨™é¡Œï¼ˆä¾‹å¦‚ï¼šweb/apiï¼‰
            prefix=$(echo "$path" | cut -d'/' -f2-3)

            if [ -z "$prefix" ]; then # å¦‚æœæ²’æœ‰å‰ç¶´ï¼Œæ­¸é¡åˆ° "Others"
              prefix="Others"
            fi

            # å°‡æª”æ¡ˆè³‡è¨Šè¿½åŠ åˆ°å°æ‡‰åˆ†é¡çš„è¨Šæ¯ä¸­
            groups["$prefix"]+="${path}ï¼ˆ+${distance}ï¼‰${NEWLINE}"
          done < log.txt

          # æ§‹å»º LINE è¨Šæ¯çš„é–‹é ­éƒ¨åˆ†
          message=$(printf "ğŸ“¢ MDN ç¿»è­¯æ›´æ–°æé†’ï¼š%s%s" "$NEWLINE" "$NEWLINE")

          # éæ­·åˆ†é¡ä¸¦å°‡å…¶å…§å®¹è¿½åŠ åˆ°è¨Šæ¯ä¸­
          for key in "${!groups[@]}"; do
            message+=$(printf "ã€%sã€‘%s" "$key" "$NEWLINE") # æ·»åŠ åˆ†é¡æ¨™é¡Œ
            message+="${groups[$key]}" # æ·»åŠ è©²åˆ†é¡ä¸‹çš„æª”æ¡ˆåˆ—è¡¨
            message+=$(printf "%s" "$NEWLINE") # æ·»åŠ ä¸€å€‹ç©ºè¡Œåˆ†éš”ä¸åŒåˆ†é¡
          done

          total=$(wc -l < log.txt) # ç²å–éæ™‚æª”æ¡ˆçš„ç¸½æ•¸é‡
          
          # å°‡ "---" ä½œç‚ºå–®ç¨çš„å­—ä¸²è¿½åŠ ï¼Œé¿å… printf éŒ¯èª¤
          message+="---"
          # ç¹¼çºŒè¿½åŠ ç¸½è¨ˆè³‡è¨Šï¼Œä½¿ç”¨ NEWLINE æ›è¡Œ
          message+=$(printf "%sç¸½è¨ˆæœªåŒæ­¥æª”æ¡ˆï¼š%s å€‹" "$NEWLINE" "$total")

          # ä½¿ç”¨ jq å°‡è¨Šæ¯å…§å®¹è½‰ç¾©ç‚º JSON æ ¼å¼ï¼Œç¢ºä¿æ›è¡Œç¬¦è™Ÿè¢«æ­£ç¢ºè™•ç†
          json_payload=$(jq -nc --arg text "$message" '{messages: [{type:"text", text:$text}]}')

          # ç™¼é€ LINE Notify å»£æ’­è¨Šæ¯
          curl -X POST https://api.line.me/v2/bot/message/broadcast \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}" \
            -d "$json_payload"
