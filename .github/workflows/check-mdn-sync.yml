name: Check MDN translation sync and send LINE notify

on:
  schedule:
    - cron: '0 4 * * *'  # æ¯å¤© 12:00 å°ç£æ™‚é–“ï¼ˆUTC+8ï¼‰åŸ·è¡Œ
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼æ­¤å·¥ä½œæµç¨‹

jobs:
  check-and-notify:
    runs-on: ubuntu-latest # åœ¨æœ€æ–°çš„ Ubuntu ç’°å¢ƒä¸­åŸ·è¡Œ

    steps:
      - name: Checkout mdn/content # ä¸‹è¼‰ mdn/content å„²å­˜åº«
        uses: actions/checkout@v4
        with:
          repository: mdn/content
          path: content # å­˜æ”¾æ–¼ content è³‡æ–™å¤¾
          fetch-depth: 0  # éœ€è¦å®Œæ•´ Git æ­·å²è¨˜éŒ„ä¾†æ¯”è¼ƒæäº¤é»

      - name: Checkout mdn/translated-content # ä¸‹è¼‰ mdn/translated-content å„²å­˜åº«
        uses: actions/checkout@v4
        with:
          repository: mdn/translated-content
          path: translated-content # å­˜æ”¾æ–¼ translated-content è³‡æ–™å¤¾

      - name: Set up Node.js + js-yaml # è¨­å®š Node.js ç’°å¢ƒä¸¦å®‰è£ js-yaml
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install js-yaml # å®‰è£è™•ç† YAML æª”æ¡ˆçš„ js-yaml å¥—ä»¶
        run: npm install js-yaml

      - name: Compare sourceCommit and generate log # æ¯”è¼ƒåŸæ–‡èˆ‡ç¿»è­¯çš„ sourceCommit ä¸¦ç”¢ç”Ÿæ—¥èªŒ
        run: |
          LOG_FILE="log.txt"
          > "$LOG_FILE" # æ¸…ç©ºæˆ–å»ºç«‹æ—¥èªŒæª”ï¼Œç¢ºä¿æ¯æ¬¡åŸ·è¡Œéƒ½æ˜¯æ–°çš„

          # æŸ¥æ‰¾æ‰€æœ‰ç¹é«”ä¸­æ–‡ Markdown æª”æ¡ˆ
          find translated-content/files/zh-tw -name '*.md' | while read -r file; do
            # æå– YAML Front Matter å€å¡Š
            yaml_metadata=$(awk '/^---$/{y++} y==1' "$file")
            # ä½¿ç”¨ Node.js å’Œ js-yaml è§£æå‡º sourceCommit
            source_commit=$(node -e "
              const yaml = require('js-yaml');
              const meta = yaml.load(\`${yaml_metadata}\`);
              console.log(meta?.l10n?.sourceCommit || '');
            ")

            [ -z "$source_commit" ] && continue # å¦‚æœæª”æ¡ˆæ²’æœ‰ sourceCommitï¼Œå‰‡è·³é

            # æ§‹å»ºå°æ‡‰çš„è‹±æ–‡åŸæ–‡æª”æ¡ˆè·¯å¾‘
            relative_path=${file#translated-content/files/zh-tw} # ç§»é™¤å‰ç¶´ï¼Œå¾—åˆ°ç›¸å°è·¯å¾‘
            en_path="files/en-us$relative_path"
            en_file="content/$en_path"

            [ ! -f "$en_file" ] && continue # å¦‚æœè‹±æ–‡åŸæ–‡æª”æ¡ˆä¸å­˜åœ¨ï¼Œå‰‡è·³é

            # å–å¾—è‹±æ–‡åŸæ–‡æª”æ¡ˆçš„æœ€æ–°æäº¤ ID
            latest_commit=$(git -C content log -n 1 --format=%H -- "$en_path")

            [ "$source_commit" = "$latest_commit" ] && continue # å¦‚æœæäº¤ ID ç›¸åŒï¼Œè¡¨ç¤ºå·²åŒæ­¥ï¼Œè·³é

            # è¨ˆç®—ç¿»è­¯è½å¾ŒåŸæ–‡çš„æäº¤æ•¸é‡
            distance=$(git -C content rev-list --count "$source_commit..$latest_commit" -- "$en_path")

            # å°‡æª”æ¡ˆè·¯å¾‘å’Œè½å¾Œæ•¸é‡å¯«å…¥æ—¥èªŒæª”
            echo "$relative_path, $distance" >> "$LOG_FILE"
          done

      - name: Upload log file # å°‡ç”Ÿæˆçš„æ—¥èªŒæª”ä¸Šå‚³ç‚ºå·¥ä½œæµç¨‹ Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mdn-l10n-outdated-log # Artifact çš„åç¨±
          path: log.txt # è¦ä¸Šå‚³çš„æª”æ¡ˆè·¯å¾‘

      - name: Format message and send LINE notification # æ ¼å¼åŒ–è¨Šæ¯ä¸¦ç™¼é€ LINE é€šçŸ¥
        if: success() # åƒ…åœ¨å‰é¢çš„æ­¥é©Ÿéƒ½æˆåŠŸå¾ŒåŸ·è¡Œ
        run: |
          if [ ! -s log.txt ]; then # æª¢æŸ¥æ—¥èªŒæª”æ˜¯å¦ç‚ºç©ºï¼ˆ-s æª¢æŸ¥æª”æ¡ˆå¤§å°æ˜¯å¦å¤§æ–¼é›¶ï¼‰
            echo "No outdated files found."
            exit 0 # å¦‚æœæ²’æœ‰éæ™‚æª”æ¡ˆï¼Œå‰‡çµæŸå·¥ä½œæµç¨‹
          fi

          declare -A groups # å®£å‘Šä¸€å€‹é—œè¯é™£åˆ— (associative array) ä¾†æŒ‰åˆ†é¡å„²å­˜æª”æ¡ˆ

          NEWLINE=$'\n' # å®šç¾©ä¸€å€‹åŒ…å«å¯¦éš›æ›è¡Œç¬¦è™Ÿçš„è®Šæ•¸ï¼Œç”¨æ–¼è¨Šæ¯ä¸­çš„æ›è¡Œ

          while IFS= read -r line; do # é€è¡Œè®€å–æ—¥èªŒæª”
            path=$(echo "$line" | cut -d',' -f1 | xargs) # æå–æª”æ¡ˆè·¯å¾‘ï¼Œä¸¦ä½¿ç”¨ xargs å»é™¤å¤šé¤˜ç©ºç™½
            distance=$(echo "$line" | cut -d',' -f2 | xargs) # æå–è½å¾Œæ•¸é‡ï¼Œä¸¦å»é™¤å¤šé¤˜ç©ºç™½

            # å¾è·¯å¾‘ä¸­æå–ç¬¬ä¸€å±¤å’Œç¬¬äºŒå±¤è³‡æ–™å¤¾ä½œç‚ºåˆ†é¡æ¨™é¡Œï¼Œä¾‹å¦‚ "web/api"
            prefix=$(echo "$path" | cut -d'/' -f2-3)

            if [ -z "$prefix" ]; then # å¦‚æœæ²’æœ‰æå–åˆ°å‰ç¶´ï¼ˆä¾‹å¦‚æ ¹ç›®éŒ„ä¸‹çš„æª”æ¡ˆï¼‰ï¼Œæ­¸é¡åˆ° "Others"
              prefix="Others"
            fi

            # å°‡æª”æ¡ˆè³‡è¨Šè¿½åŠ åˆ°å°æ‡‰åˆ†é¡çš„è¨Šæ¯ä¸­
            groups["$prefix"]+="${path}ï¼ˆ+${distance}ï¼‰${NEWLINE}"
          done < log.txt

          # æ§‹å»º LINE è¨Šæ¯çš„é–‹é ­éƒ¨åˆ†
          message=$(printf "ğŸ“¢ MDN ç¿»è­¯æ›´æ–°æé†’ï¼š%s%s" "$NEWLINE" "$NEWLINE")

          first_group=true # æ——æ¨™ï¼Œç”¨æ–¼æ§åˆ¶åˆ†é¡é–“çš„é¡å¤–æ›è¡Œ

          # éæ­·æ‰€æœ‰åˆ†é¡ï¼Œå°‡å…¶å…§å®¹è¿½åŠ åˆ°è¨Šæ¯ä¸­
          for key in "${!groups[@]}"; do
            if [ "$first_group" = false ]; then
              message+=$(printf "%s%s" "$NEWLINE" "$NEWLINE") # åœ¨ä¸åŒä¸»é¡Œä¹‹é–“å¢åŠ å…©å€‹æ›è¡Œ
            fi
            message+=$(printf "ã€%sã€‘%s%s" "$key" "$NEWLINE" "$NEWLINE") # æ·»åŠ åˆ†é¡æ¨™é¡Œï¼Œå¾Œé¢è·Ÿå…©å€‹æ›è¡Œ
            message+="${groups[$key]}" # æ·»åŠ è©²åˆ†é¡ä¸‹çš„æª”æ¡ˆåˆ—è¡¨
            first_group=false # å°‡æ——æ¨™è¨­ç‚º falseï¼Œè¡¨ç¤ºå·²ç¶“è™•ç†éç¬¬ä¸€å€‹ç¾¤çµ„
          done

          total=$(wc -l < log.txt) # ç²å–éæ™‚æª”æ¡ˆçš„ç¸½æ•¸é‡
          
          # åœ¨ç¸½çµè³‡è¨Šå‰å¢åŠ å…©å€‹æ›è¡Œï¼Œæå‡é–±è®€é«”é©—
          message+=$(printf "%s%s" "$NEWLINE" "$NEWLINE") 
          message+="---" # æ·»åŠ åˆ†éš”ç·š
          # è¿½åŠ ç¸½è¨ˆè³‡è¨Šï¼Œä¸¦ä½¿ç”¨ NEWLINE æ›è¡Œ
          message+=$(printf "%sç¸½è¨ˆæœªåŒæ­¥æª”æ¡ˆï¼š%s å€‹" "$NEWLINE" "$total")

          # ä½¿ç”¨ jq å°‡ Bash è®Šæ•¸ä¸­çš„è¨Šæ¯å…§å®¹è½‰ç¾©ç‚º JSON æ ¼å¼
          # é€™æ¨£ LINE API æ‰èƒ½æ­£ç¢ºè§£æå…¶ä¸­çš„æ›è¡Œç¬¦è™Ÿ
          json_payload=$(jq -nc --arg text "$message" '{messages: [{type:"text", text:$text}]}')

          # ç™¼é€ LINE Notify å»£æ’­è¨Šæ¯
          curl -X POST https://api.line.me/v2/bot/message/broadcast \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}" \
            -d "$json_payload"
