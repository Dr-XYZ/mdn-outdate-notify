name: Check MDN translation sync and send LINE notify

on:
  schedule:
    - cron: '0 4 * * *'  # æ¯å¤© 12:00 å°ç£æ™‚é–“ï¼ˆUTC+8ï¼‰
  workflow_dispatch:

jobs:
  check-and-notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout mdn/content
        uses: actions/checkout@v4
        with:
          repository: mdn/content
          path: content
          fetch-depth: 0  # éœ€è¦å®Œæ•´ git log

      - name: Checkout mdn/translated-content
        uses: actions/checkout@v4
        with:
          repository: mdn/translated-content
          path: translated-content

      - name: Set up Node.js + js-yaml
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install js-yaml
        run: npm install js-yaml

      - name: Compare sourceCommit and generate log
        run: |
          LOG_FILE="log.txt"
          > "$LOG_FILE"

          find translated-content/files/zh-tw -name '*.md' | while read -r file; do
            yaml_metadata=$(awk '/^---$/{y++} y==1' "$file")
            source_commit=$(node -e "
              const yaml = require('js-yaml');
              const meta = yaml.load(\`${yaml_metadata}\`);
              console.log(meta?.l10n?.sourceCommit || '');
            ")

            [ -z "$source_commit" ] && continue

            relative_path=${file#translated-content/files/zh-tw}
            en_path="files/en-us$relative_path"
            en_file="content/$en_path"

            [ ! -f "$en_file" ] && continue

            latest_commit=$(git -C content log -n 1 --format=%H -- "$en_path")

            [ "$source_commit" = "$latest_commit" ] && continue

            distance=$(git -C content rev-list --count "$source_commit..$latest_commit" -- "$en_path")

            echo "$relative_path, $distance" >> "$LOG_FILE"
          done

      - name: Upload log file
        uses: actions/upload-artifact@v4
        with:
          name: mdn-l10n-outdated-log
          path: log.txt

      - name: Format message and send LINE notification
        if: success()
        run: |
          if [ ! -s log.txt ]; then
            echo "No outdated files found."
            exit 0
          fi

          declare -A groups

          while IFS= read -r line; do
            path=$(echo "$line" | cut -d',' -f1 | xargs) # å»é™¤ç©ºç™½
            distance=$(echo "$line" | cut -d',' -f2 | xargs)

            # å–ç¬¬ä¸€å±¤è³‡æ–™å¤¾+ç¬¬äºŒå±¤è³‡æ–™å¤¾ä½œç‚ºåˆ†é¡æ¨™é¡Œï¼Œä¾‹å¦‚ web/api
            prefix=$(echo "$path" | cut -d'/' -f2-3)

            # æ²’æœ‰å°±æ”¾ Others
            if [ -z "$prefix" ]; then
              prefix="Others"
            fi
            
            # ç›´æ¥åœ¨ Bash å­—ä¸²ä¸­æ’å…¥æ›è¡Œ
            groups["$prefix"]+="${path}ï¼ˆ+${distance}ï¼‰
"
          done < log.txt

          # ç›´æ¥åœ¨ Bash å­—ä¸²ä¸­æ’å…¥æ›è¡Œ
          message="ğŸ“¢ MDN ç¿»è­¯æ›´æ–°æé†’ï¼š

"

          for key in "${!groups[@]}"; do
            # ç›´æ¥åœ¨ Bash å­—ä¸²ä¸­æ’å…¥æ›è¡Œ
            message+="ã€${key}ã€‘
"
            message+="${groups[$key]}"
            message+="
"
          done

          total=$(wc -l < log.txt)
          # ç›´æ¥åœ¨ Bash å­—ä¸²ä¸­æ’å…¥æ›è¡Œ
          message+="---
ç¸½è¨ˆæœªåŒæ­¥æª”æ¡ˆï¼š${total} å€‹"

          # é—œéµæ­¥é©Ÿï¼šä½¿ç”¨ jq -R -s å°‡å¤šè¡Œå­—ä¸²æ­£ç¢ºè½‰æ›ç‚º JSON æ ¼å¼
          # -R (raw input) å°‡è¼¸å…¥è¦–ç‚ºåŸå§‹å­—ä¸²
          # -s (slurp) å°‡æ‰€æœ‰è¼¸å…¥è®€å–ç‚ºä¸€å€‹å–®ä¸€å­—ä¸²
          # . (dot) è¡¨ç¤º jq å°‡è©²å­—ä¸²ä½œç‚ºå…¶å€¼
          json_payload=$(echo -e "$message" | jq -R -s '{messages: [{type:"text", text:.}]}')

          curl -X POST https://api.line.me/v2/bot/message/broadcast \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}" \
            -d "$json_payload"
